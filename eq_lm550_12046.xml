<?xml version="1.0"?>
<!DOCTYPE ladspa SYSTEM "ladspa-swh.dtd">
<?xml-stylesheet href="ladspa.css" type="text/css"?>
<ladspa>
  <global>
    <meta name="maker" value=" Luis Maria Pizarro &lt;lmpizarro@gmail.com&gt;"/>
    <meta name="copyright" value="GPL"/>
    <meta name="properties" value="HARD_RT_CAPABLE"/>
    <code>
      #include "ladspa-util.h"
      #include "util/db.h"
      #include "util/filters.h"
    </code>
  </global>

  <plugin label="eq_lm550" id="12046" class="FilterPlugin">
    <name>eq_lm550</name>
    <p>A plugin that implements the </p>

    <callback event="instantiate"><![CDATA[
      fs = s_rate;
      rmsFilterINP = rms_filter_new(5.0f, fs);
      rmsFilterOUT = rms_filter_new(5.0f, fs);
    ]]></callback>

    <callback event="activate"> 
    </callback>

    <callback event="cleanup">
       rms_filter_free(plugin_data->rmsFilterINP);
       rms_filter_free(plugin_data->rmsFilterOUT);
    </callback>

    <callback event="run"><![CDATA[
      unsigned long pos;
      float iGain = DB_CO(inputGain);
      float oGain = DB_CO(outputGain);
      float p1Fc;
      float p2Fc;
      float p3Fc;
      float p1G = DB_CO(f1Gain);
      float p2G = DB_CO(f2Gain);
      float p3G = DB_CO(f3Gain);
      float tmp;
      float p1Freqs [7] ={30.0f, 40.0f, 50.0f, 100.0f, 200.0f, 300.0f, 400.0f}; 
      float p2Freqs [7] ={200.0f, 400.0f, 600.0f, 800.0f, 1500.0f, 3000.0f, 5000.0f}; 
      float p3Freqs [7] ={2500.0f, 5000.0f, 7000.0f, 10000.0f, 12500.0f, 15000.0f, 20000.0f}; 
      float out;

      p1Fc = p1Freqs[(int)f1Fc];
      p2Fc = p2Freqs[(int)f2Fc];
      p3Fc = p3Freqs[(int)f3Fc];
      if (BPON == 1) tmp = 1.0f;
      if (LFSHON == 1) tmp = 1.0f;
      if (HFSHON == 1) tmp = 1.0f;
    
      p1Fc = 1.0f * p1Fc * p2Fc * p3Fc * p1G * p2G * p3G;

      for (pos = 0; pos < sample_count; pos++) {
        tmp = input[pos]*(1-dryWet) + dryWet * input[pos] * iGain * oGain * fs;
	tmp = 1.0f + tmp;

	out = input[pos] *iGain * oGain;
	buffer_write(output[pos], out);

	*(plugin_data->guiRMSInp) = 20*log10(rms_filter_process(rmsFilterINP , input[pos]) + 0.001f);

        *(plugin_data->guiRMSOut) = 20*log10(rms_filter_process(rmsFilterOUT , output[pos]) + 0.001f);
      }
      ]]></callback>

    <port label="inputGain" dir="input" type="control" hint="default_0">
      <name>InGain</name>
      <p>Controls the gain of the input signal in dB's.</p>
      <range min="-12" max="+12"/>
    </port>

    <port label="f1Fc" dir="input" type="control" hint="default_middle, integer">
	<name>f1Fc Khz(0=.03, 1=.04, 2=.05, 3=.1, 4=.2, 5=.3, 6=.4)</name>
	<range min="0" max="6"/>
    </port>

    <port label="f1Gain" dir="input" type="control" hint="integer,default_0">
      <name>p1Gain DB(-5|-12 -4|-9 -3|-6 -2|-4 -1|-2 0|0 1|2 2|4 3|6 4|9 5|12)</name>
      <p>Controls the gain of the peak 1 filter.</p>
      <range min="-5" max="+5"/>
    </port>

    <port label="f2Fc" dir="input" type="control" hint="integer,default_middle">
	<name>f2Fc Khz(0|.2, 1|.4, 2|.6, 3|.8, 4|1.5, 5|3.0, 6|5.0)</name>
	<range min="0" max="6"/>
    </port>

    <port label="f2Gain" dir="input" type="control" hint="integer,default_0">
      <name>p2Gain DB(-5|-12 -4|-9 -3|-6 -2|-4 -1|-2 0|0 1|2 2|4 3|6 4|9 5|12)</name>
      <p>Controls the gain of the peak 2 filter.</p>
      <range min="-5" max="+5"/>
    </port>

    <port label="f3Fc" dir="input" type="control" hint="integer,default_middle">
	<name>f3Fc Khz (0|2.5, 1|5.0, 2|7.0, 3|10.0, 4|12.5, 5|15.0, 6|20.0)</name>
	<range min="0" max="6"/>
    </port>

    <port label="f3Gain" dir="input" type="control" hint="integer,default_0">
      <name>p3Gain DB(-5|-12 -4|-9 -3|-6 -2|-4 -1|-2 0|0 1|2 2|4 3|6 4|9 5|12)</name>
      <p>Controls the gain of the peak 3 filter.</p>
      <range min="-5" max="+5"/>
    </port>

    <port label="outputGain" dir="input" type="control" hint="default_0">
      <name>OutGain</name>
      <p>Controls the gain of the output signal in dB's.</p>
      <range min="-12" max="+12"/>
    </port>

    <port label="dryWet" dir="input" type="control" hint="default_0">
      <name>Dry/Wet</name>
      <p>Controls the gain of the output signal in dB's.</p>
      <range min="0" max="+1"/>
    </port>

    <port label="BPON" dir="input" type="control" hint="integer,default_0">
      <name>BP active(0 = ON, 1 = OFF)</name>
      <p>BP 50 15Kz activate</p>
      <range min="0" max="1"/>
    </port>
    <port label="LFSHON" dir="input" type="control" hint="integer,default_0">
      <name>LFSH active(0 = ON, 1 = OFF)</name>
      <p>activate LFSH or PEAK</p>
      <range min="0" max="1"/>
    </port>
    <port label="HFSHON" dir="input" type="control" hint="integer,default_0">
      <name>HFSH active(0 = ON, 1 = OFF)</name>
      <p>activate HFSH or PEAK</p>
      <range min="0" max="1"/>
    </port>

    <port label="input" dir="input" type="audio">
      <name>Input</name>
    </port> 

    <port label="output" dir="output" type="audio">
      <name>Output</name>
    </port>

    <port label="guiRMSInp" dir="output" type="control">
      <name>InRMS (dB)</name>
      <p>The level of the input signal, in decibels.</p>
      <range min="-40" max="+12"/>
    </port>

    <port label="guiRMSOut" dir="output" type="control">
      <name>OutRMS (dB)</name>
      <p>The level of the input signal, in decibels.</p>
      <range min="-40" max="+12"/>
    </port>

    <instance-data label="fs" type="float" />
    <instance-data label="rmsFilterINP" type="rms_filter *"/>
    <instance-data label="rmsFilterOUT" type="rms_filter *"/>
  </plugin>
</ladspa>
